<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Wojsko QD</title>
  <style>
    :root{
      --bg:#f3f6f8;
      --card:#ffffff;
      --text:#0b0f17;
      --muted:#6b7684;
      --accent:#2f8f55;
      --danger:#e74c3c;
      --glass: rgba(255,255,255,0.6);
    }
    [data-theme="dark"]{
      --bg:#0b0c0f;
      --card:#0f1114;
      --text:#e6eef6;
      --muted:#9aa6b2;
      --accent:#3fc37a;
      --glass: rgba(8,9,11,0.6);
    }

    *{box-sizing:border-box;font-family:Inter,Segoe UI,system-ui,Helvetica,Arial;margin:0}
    html,body{height:100%}
    body{
      background:var(--bg);
      color:var(--text);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    header{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 18px;
      background:linear-gradient(180deg, rgba(0,0,0,0.03), transparent);
      border-bottom:1px solid rgba(0,0,0,0.06);
    }
    .logo{font-weight:800;letter-spacing:1px}
    #topControls{display:flex;align-items:center;gap:12px}

    main{flex:1;display:flex;gap:14px;padding:18px;align-items:stretch}

    /* left / chat area */
    .leftPanel{flex:1;display:flex;flex-direction:column;gap:14px;min-width:0}
    .card{background:var(--card);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(2,6,23,0.06);border:1px solid rgba(0,0,0,0.04)}
    #chat{display:flex;flex-direction:column;min-height:400px;height:calc(100vh - 220px)}
    #messages{flex:1;overflow:auto;padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(0,0,0,0.02), transparent);border:1px dashed rgba(0,0,0,0.03)}
    .msg{margin-bottom:10px;padding:8px;border-radius:10px;max-width:78%}
    .msg.me{background:linear-gradient(90deg, rgba(47,143,85,0.08), transparent);align-self:flex-end}
    .msg.other{background:transparent;border-left:3px solid rgba(0,0,0,0.03)}
    .send{display:flex;gap:8px;margin-top:8px}
    input[type="text"], input[type="email"], input[type="password"], select{
      padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);width:100%;background:transparent;color:var(--text)
    }
    button{padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:white;cursor:pointer}
    .pill{padding:6px 10px;border-radius:999px;background:var(--glass);border:1px solid rgba(0,0,0,0.04);cursor:pointer}
    .small{font-size:13px;color:var(--muted)}
    .badge{font-size:12px;padding:6px 10px;border-radius:8px;background:rgba(0,0,0,0.05)}

    /* right / sidebar */
    aside.right{width:360px;display:flex;flex-direction:column;gap:12px;position:relative;min-width:60px}
    #sideToggle{
      position:absolute;left:-36px;top:20px;width:36px;height:56px;border-radius:8px;
      background:var(--card);display:flex;align-items:center;justify-content:center;
      box-shadow:0 6px 12px rgba(2,6,23,0.06);cursor:pointer;border:1px solid rgba(0,0,0,0.04);
    }
    .user-table{max-height:62vh;overflow:auto;border-radius:8px;margin-top:8px}
    .user-row{display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(0,0,0,0.03)}
    .user-left{display:flex;gap:10px;align-items:center}
    .dot{width:12px;height:12px;border-radius:50%;box-shadow:0 0 6px rgba(0,0,0,0.08)}
    .rankLabel{font-weight:700}
    .hoverPlus{display:inline-block;padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);cursor:pointer;margin-left:8px;background:transparent}

    /* modal / overlay */
    #modalRoot{z-index:9999}
    #overlayBlock{
      position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;
      color:white;font-size:22px;font-weight:700;display:none
    }
    .modal{width:420px;max-width:94%;border-radius:12px;padding:12px}

    /* responsive */
    @media(max-width:900px){
      aside.right{display:none}
    }
  </style>
</head>
<body data-theme="light">
  <header>
    <div class="logo">WOJSKO QD</div>
    <div id="topControls">
      <div id="authArea"></div>
      <div id="settingsGear" title="Ustawienia" style="cursor:pointer">‚öôÔ∏è</div>
      <div id="adminPanelBtn" title="Panel admina" style="cursor:pointer;display:none">üõ°Ô∏è</div>
    </div>
  </header>

  <main>
    <section class="leftPanel">
      <div class="card">
        <h3 style="margin-bottom:8px">Chat og√≥lny</h3>
        <div id="chat">
          <div id="messages" aria-live="polite"></div>
          <div class="send">
            <input id="msgInput" type="text" placeholder="Napisz wiadomo≈õƒá..." />
            <button id="sendBtn">Wy≈õlij</button>
          </div>
        </div>
      </div>

      <div class="card" id="profileCard">
        <h4>INFORMACJE O TOBIE:</h4>
        <div style="display:flex;flex-direction:column;gap:6px;padding-top:6px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>IMIƒò:</strong></div>
            <div id="profileName" class="small">‚Äî</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>NAZWISKO:</strong></div>
            <div id="profileLastName" class="small">‚Äî</div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>Gmail:</strong></div>
            <div style="display:flex;align-items:center;gap:8px">
              <div id="profileEmail" class="small">‚Äî</div>
              <button id="changeEmailBtn" class="pill small">ZMIEN</button>
            </div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><strong>RANGA:</strong></div>
            <div id="profileRank" class="badge">‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <aside class="right">
      <div id="sideToggle">‚ùØ</div>

      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <strong>≈ªo≈Çnierze</strong>
          <div class="small">Lista</div>
        </div>
        <div id="userListWrap" class="user-table"></div>
      </div>

      <div class="card">
        <strong>Kontrola rang</strong>
        <p class="small">Najed≈∫ na u≈ºytkownika ‚Üí kliknij <span style="font-weight:700">+</span> aby nadaƒá rangƒô. Domy≈õlnie: <strong>Szeregowy</strong>.</p>
      </div>
    </aside>
  </main>

  <div id="modalRoot"></div>
  <div id="overlayBlock">JESTE≈ö CHWILOWO ZABLOKOWANY</div>

  <script>
  /*****************************************************************
   * Wojsko QD - single-file app (localStorage + BroadcastChannel)
   * - start: login/reg modal blocks until login
   * - owner account pre-created: Mateusz Myjak (Genera≈Ç)
   * - chat, sidebar toggle, settings gear, admin panel for Generals
   *****************************************************************/

  /* --------- Configuration & constants --------- */
  const RANKS = ['Genera≈Ç','Pu≈Çkownik','Major','Kapitan','Plutonowy','Szeregowy'];
  const DEFAULT_RANK = 'Szeregowy';
  const OWNER_EMAIL = 'mateuszgaming422@gmail.com';
  const OWNER_NAME = 'Mateusz';
  const OWNER_LAST = 'Myjak';
  const OWNER_PASS = 'mateusz123'; // change in settings!
  const STORAGE_USERS = 'qd_users_v3';
  const STORAGE_CHAT = 'qd_chat_v3';
  const STORAGE_SESSION = 'qd_session_v3';
  const BROADCAST_NAME = 'qd_channel_v3';

  /* --------- Utilities --------- */
  function uid(){ return 'id_' + Math.random().toString(36).slice(2,9); }
  function now(){ return Date.now(); }
  function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

  /* --------- Storage helpers --------- */
  function loadUsers(){ return JSON.parse(localStorage.getItem(STORAGE_USERS) || '[]'); }
  function saveUsers(users){ localStorage.setItem(STORAGE_USERS, JSON.stringify(users)); }
  function loadChat(){ return JSON.parse(localStorage.getItem(STORAGE_CHAT) || '[]'); }
  function saveChat(chat){ localStorage.setItem(STORAGE_CHAT, JSON.stringify(chat)); }

  /* --------- Broadcast (sync between tabs) --------- */
  const bc = ('BroadcastChannel' in window) ? new BroadcastChannel(BROADCAST_NAME) : null;
  function broadcast(type, payload){
    if(bc) bc.postMessage({type, payload});
    // fallback trigger
    localStorage.setItem('qd_bcast_last', JSON.stringify({type, payload, t: now()}));
  }
  window.addEventListener('storage', (e) => {
    if(e.key === 'qd_bcast_last' && e.newValue){
      const ev = JSON.parse(e.newValue);
      handleIncoming(ev.type, ev.payload, true);
    }
  });
  if(bc) bc.onmessage = m => handleIncoming(m.data.type, m.data.payload, false);

  function handleIncoming(type, payload, fromStorage){
    if(type === 'chat'){
      const chat = loadChat();
      chat.push(payload);
      saveChat(chat);
      renderMessages();
    } else if(type === 'user-update'){
      renderUserList();
      renderProfile();
    } else if(type === 'presence'){
      const users = loadUsers();
      const u = users.find(x => x.id === payload.id);
      if(u){ u.lastSeen = payload.t; saveUsers(users); renderUserList(); renderProfile(); }
    } else if(type === 'admin-action'){
      applyAdminAction(payload);
    }
  }

  /* --------- Ensure owner exists (only owner at start) --------- */
  (function ensureOwner(){
    const users = loadUsers();
    if(!users.find(u => u.email === OWNER_EMAIL)){
      const owner = {
        id: uid(),
        name: OWNER_NAME,
        lastName: OWNER_LAST,
        email: OWNER_EMAIL,
        pass: OWNER_PASS,
        rank: 'Genera≈Ç',
        isOwner: true,
        lastSeen: now(),
        muted: false,
        blocked: false,
        warned: false
      };
      users.push(owner);
      saveUsers(users);
    }
  })();

  /* --------- Session & presence --------- */
  let currentUser = null;
  function setSession(user){
    currentUser = user;
    localStorage.setItem(STORAGE_SESSION, JSON.stringify({id: user.id, t: now()}));
    renderAuthArea();
    renderProfile();
    markActive();
    broadcast('presence', {id: user.id, t: now()});
    renderUserList();
  }
  function clearSession(){
    currentUser = null;
    localStorage.removeItem(STORAGE_SESSION);
    renderAuthArea();
    renderProfile();
  }

  function markActive(){
    if(!currentUser) return;
    const users = loadUsers();
    const u = users.find(x => x.id === currentUser.id);
    if(u){ u.lastSeen = now(); saveUsers(users); broadcast('presence', {id: u.id, t: u.lastSeen}); }
  }
  setInterval(markActive, 5000);
  window.addEventListener('focus', markActive);
  document.addEventListener('click', markActive);

  /* --------- UI Rendering --------- */
  const authArea = document.getElementById('authArea');
  function renderAuthArea(){
    authArea.innerHTML = '';
    const sess = JSON.parse(localStorage.getItem(STORAGE_SESSION) || 'null');
    if(sess){
      const users = loadUsers();
      const u = users.find(x => x.id === sess.id);
      if(u) currentUser = u;
    }
    if(currentUser){
      const wrapper = document.createElement('div');
      wrapper.style.display = 'flex';
      wrapper.style.alignItems = 'center';
      wrapper.style.gap = '8px';
      wrapper.innerHTML = `
        <div class="small">${currentUser.name} ${currentUser.lastName[0]}. ‚Ä¢ ${currentUser.rank}</div>
        <button id="logoutBtn" class="pill small">Wyloguj</button>
      `;
      authArea.appendChild(wrapper);
      document.getElementById('logoutBtn').onclick = () => { clearSession(); showLoginOnStart(); }
    } else {
      const wrapper = document.createElement('div');
      wrapper.innerHTML = `
        <button id="showLogin" class="pill small">Zaloguj</button>
        <button id="showRegister" class="pill small">Zarejestruj</button>
      `;
      authArea.appendChild(wrapper);
      document.getElementById('showLogin').onclick = openLoginModal;
      document.getElementById('showRegister').onclick = openRegisterModal;
    }
  }
  renderAuthArea();

  function renderProfile(){
    document.getElementById('profileName').textContent = currentUser ? currentUser.name : '‚Äî';
    document.getElementById('profileLastName').textContent = currentUser ? currentUser.lastName : '‚Äî';
    document.getElementById('profileEmail').textContent = currentUser ? currentUser.email : '‚Äî';
    document.getElementById('profileRank').textContent = currentUser ? currentUser.rank : '‚Äî';
    document.getElementById('changeEmailBtn').onclick = () => { if(!currentUser) return openLoginModal(); openChangeEmailModal(); }

    // show admin button for Genera≈Ç / owner
    const adminBtn = document.getElementById('adminPanelBtn');
    if(currentUser && (currentUser.rank === 'Genera≈Ç' || currentUser.isOwner)){
      adminBtn.style.display = 'inline-block';
    } else {
      adminBtn.style.display = 'none';
    }

    // show block overlay if current user is blocked
    if(currentUser && currentUser.blocked){
      document.getElementById('overlayBlock').style.display = 'flex';
    } else {
      document.getElementById('overlayBlock').style.display = 'none';
    }
  }

  /* --------- Messages (chat) --------- */
  function renderMessages(){
    const messages = loadChat();
    const el = document.getElementById('messages');
    el.innerHTML = '';
    messages.slice(-500).forEach(m => {
      const div = document.createElement('div');
      div.className = 'msg ' + (currentUser && m.fromId === currentUser.id ? 'me' : 'other');
      const users = loadUsers();
      const u = users.find(x => x.id === m.fromId);
      const name = u ? `${u.name} ${u.lastName[0]}.` : 'Nieznany';
      div.innerHTML = `<div style="font-size:12px;color:var(--muted)">${name} <span style="font-size:11px;color:var(--muted)">¬∑ ${new Date(m.t).toLocaleTimeString()}</span></div><div style="margin-top:6px">${escapeHtml(m.text)}</div>`;
      el.appendChild(div);
    });
    el.scrollTop = el.scrollHeight;
  }
  renderMessages();

  document.getElementById('sendBtn').onclick = sendMessage;
  document.getElementById('msgInput').addEventListener('keydown', (e) => { if(e.key === 'Enter') sendMessage(); });

  function sendMessage(){
    if(!currentUser){ alert('Musisz siƒô zalogowaƒá.'); openLoginModal(); return; }
    const users = loadUsers();
    const me = users.find(x => x.id === currentUser.id);
    if(me && me.muted){ alert('Jeste≈õ wyciszony i nie mo≈ºesz pisaƒá.'); return; }
    if(me && me.blocked){ alert('Jeste≈õ zablokowany.'); return; }
    const input = document.getElementById('msgInput');
    const text = input.value.trim();
    if(!text) return;
    const msg = { id: uid(), fromId: currentUser.id, text, t: now() };
    const chat = loadChat();
    chat.push(msg);
    saveChat(chat);
    broadcast('chat', msg);
    input.value = '';
    renderMessages();
  }

  /* --------- User list & interactions --------- */
  const userListWrap = document.getElementById('userListWrap');
  function renderUserList(){
    const users = loadUsers().slice().sort((a,b) => {
      if(a.rank === b.rank) return a.name.localeCompare(b.name);
      return RANKS.indexOf(a.rank) - RANKS.indexOf(b.rank);
    });
    userListWrap.innerHTML = '';
    users.forEach(u => {
      const row = document.createElement('div');
      row.className = 'user-row';

      const left = document.createElement('div');
      left.className = 'user-left';

      const dot = document.createElement('div');
      dot.className = 'dot';
      const active = (now() - (u.lastSeen || 0)) < 30000; // 30s window
      dot.style.background = active ? 'var(--accent)' : 'var(--danger)';
      left.appendChild(dot);

      const info = document.createElement('div');
      info.innerHTML = `<div class="rankLabel">${u.rank} | ${u.name} ${u.lastName[0]}.</div><div class="small">${u.email || ''}</div>`;
      left.appendChild(info);

      row.appendChild(left);

      const controls = document.createElement('div');
      controls.innerHTML = `<span class="hoverPlus" title="Edytuj rangƒô">+</span>`;
      controls.querySelector('.hoverPlus').onclick = (e) => {
        e.stopPropagation();
        openAssignRankModal(u.id);
      };
      row.appendChild(controls);

      row.onclick = () => { openUserDetailModal(u.id); };

      userListWrap.appendChild(row);
    });
  }
  renderUserList();

  /* --------- Sidebar toggle (big arrow) --------- */
  const sideToggleBtn = document.getElementById('sideToggle');
  let sideOpen = true;
  sideToggleBtn.addEventListener('click', toggleSide);
  function toggleSide(){
    const side = document.querySelector('aside.right');
    const listWrap = document.getElementById('userListWrap');
    if(sideOpen){
      side.style.width = '60px';
      side.style.padding = '12px 6px';
      listWrap.style.display = 'none';
      sideToggleBtn.innerText = '‚ùÆ';
      sideOpen = false;
    } else {
      side.style.width = '360px';
      side.style.padding = '12px';
      listWrap.style.display = 'block';
      sideToggleBtn.innerText = '‚ùØ';
      sideOpen = true;
    }
  }

  /* --------- Modal helpers --------- */
  const modalRoot = document.getElementById('modalRoot');
  function openModal(html){
    modalRoot.innerHTML = `
      <div id="overlay" style="position:fixed;inset:0;background:rgba(0,0,0,0.35);display:flex;align-items:center;justify-content:center;z-index:9999">
        <div class="card modal">${html}</div>
      </div>
    `;
    document.getElementById('overlay').addEventListener('click', (e) => { if(e.target.id === 'overlay') closeModal(); });
  }
  function closeModal(){ modalRoot.innerHTML = ''; }

  /* --------- Login / Register (blocking on start) --------- */
  function openLoginModal(){
    openModal(`
      <h3>Logowanie</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="loginEmail" type="email" placeholder="Email" />
        <input id="loginPass" type="password" placeholder="Has≈Ço" />
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="cancelLogin" class="pill small">Anuluj</button>
          <button id="doLogin" class="pill small">Zaloguj</button>
        </div>
      </div>
    `);
    document.getElementById('cancelLogin').onclick = () => { closeModal(); showLoginOnStart(); };
    document.getElementById('doLogin').onclick = () => {
      const email = document.getElementById('loginEmail').value.trim().toLowerCase();
      const pass = document.getElementById('loginPass').value;
      const users = loadUsers();
      const u = users.find(x => x.email.toLowerCase() === email && x.pass === pass);
      if(!u){ alert('B≈Çƒôdny email lub has≈Ço.'); return; }
      if(u.blocked){ document.getElementById('overlayBlock').style.display = 'flex'; /* will also login but show overlay */ }
      setSession(u);
      closeModal();
    };
  }

  function openRegisterModal(){
    openModal(`
      <h3>Rejestracja</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="regName" placeholder="Imiƒô" />
        <input id="regLast" placeholder="Nazwisko" />
        <input id="regEmail" type="email" placeholder="Email" />
        <input id="regPass" type="password" placeholder="Has≈Ço" />
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="cancelReg" class="pill small">Anuluj</button>
          <button id="doReg" class="pill small">Zarejestruj</button>
        </div>
      </div>
    `);
    document.getElementById('cancelReg').onclick = () => { closeModal(); showLoginOnStart(); };
    document.getElementById('doReg').onclick = () => {
      const name = document.getElementById('regName').value.trim();
      const last = document.getElementById('regLast').value.trim();
      const email = document.getElementById('regEmail').value.trim().toLowerCase();
      const pass = document.getElementById('regPass').value;
      if(!name || !last || !email || !pass){ alert('Wype≈Çnij wszystkie pola.'); return; }
      const users = loadUsers();
      if(users.some(x => x.email.toLowerCase() === email)){ alert('Konto o tym mailu ju≈º istnieje.'); return; }
      const u = { id: uid(), name, lastName: last, email, pass, rank: DEFAULT_RANK, lastSeen: now(), muted: false, blocked: false, warned: false };
      users.push(u); saveUsers(users);
      broadcast('user-update', { id: u.id });
      setSession(u);
      closeModal();
      renderUserList();
    };
  }

  /* Block-on-start */
  function showLoginOnStart(){
    openLoginModal();
    // ensure overlay captures clicks
    const overlay = document.getElementById('overlay');
    if(overlay) overlay.style.pointerEvents = 'auto';
  }

  /* --------- Assign rank interface (plus on hover) --------- */
  function openAssignRankModal(targetId){
    if(!currentUser){ alert('Musisz siƒô zalogowaƒá.'); openLoginModal(); return; }
    const users = loadUsers();
    const target = users.find(x => x.id === targetId);
    if(!target) return alert('U≈ºytkownik nie znaleziony.');

    // permissions: owner OR Genera≈Ç OR self
    const canAssign = (currentUser.isOwner) || (currentUser.rank === 'Genera≈Ç') || (currentUser.id === targetId);
    if(!canAssign) return alert('Nie masz uprawnie≈Ñ do nadawania rang.');

    // cannot edit owner unless owner
    const owner = users.find(x => x.isOwner);
    if(owner && targetId === owner.id && !currentUser.isOwner) return alert('Nie mo≈ºesz zmieniaƒá rangi w≈Ça≈õciciela.');

    openModal(`
      <h3>Edytuj rangƒô ‚Äî ${target.name} ${target.lastName}</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <select id="rankSelect">
          ${RANKS.map(r => `<option ${r === target.rank ? 'selected' : ''}>${r}</option>`).join('')}
        </select>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="cancelAssign" class="pill small">Anuluj</button>
          <button id="saveAssign" class="pill small">Zapisz</button>
        </div>
      </div>
    `);
    document.getElementById('cancelAssign').onclick = closeModal;
    document.getElementById('saveAssign').onclick = () => {
      const newRank = document.getElementById('rankSelect').value;
      const users2 = loadUsers();
      const t = users2.find(x => x.id === targetId);
      if(!t) return;
      t.rank = newRank;
      saveUsers(users2);
      broadcast('user-update', { id: t.id });
      closeModal();
      renderUserList();
      renderProfile();
    };
  }

  /* --------- User detail modal (kick) --------- */
  function openUserDetailModal(targetId){
    const users = loadUsers();
    const u = users.find(x => x.id === targetId);
    if(!u) return;
    const canAdmin = currentUser && ( (currentUser.rank === 'Genera≈Ç') || currentUser.isOwner ) && !u.isOwner;
    openModal(`
      <h3>Informacje ‚Äî ${u.name} ${u.lastName}</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div><strong>Ranga:</strong> ${u.rank}</div>
        <div><strong>Email:</strong> ${u.email}</div>
        <div><strong>Aktywny:</strong> ${(now() - (u.lastSeen || 0)) < 30000 ? 'tak' : 'nie'}</div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
          <button id="closeDetail" class="pill small">Zamknij</button>
          ${canAdmin ? '<button id="kickBtn" class="pill small">Wyrzuƒá</button>' : ''}
        </div>
      </div>
    `);
    document.getElementById('closeDetail').onclick = closeModal;
    if(canAdmin){
      document.getElementById('kickBtn').onclick = () => {
        if(!confirm('UsunƒÖƒá u≈ºytkownika?')) return;
        const us = loadUsers().filter(x => x.id !== u.id);
        saveUsers(us);
        broadcast('user-update', { id: u.id });
        closeModal();
        renderUserList();
      };
    }
  }

  /* --------- Settings & admin panel --------- */
  document.getElementById('settingsGear').onclick = openSettingsModal;
  document.getElementById('adminPanelBtn').onclick = openAdminPanel;

  function openSettingsModal(){
    openModal(`
      <h3>Ustawienia</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <div><strong>Tryb:</strong>
          <select id="themeSelect"><option>light</option><option>dark</option></select>
        </div>

        <div><strong>Zmie≈Ñ has≈Ço</strong>
          <input id="oldPass" type="password" placeholder="Stare has≈Ço" />
          <input id="newPass" type="password" placeholder="Nowe has≈Ço" />
          <button id="changePassBtn" class="pill small">Zmie≈Ñ has≈Ço</button>
        </div>

        <div style="display:flex;justify-content:flex-end">
          <button id="closeSettings" class="pill small">Zamknij</button>
        </div>
      </div>
    `);

    document.getElementById('closeSettings').onclick = closeModal;
    document.getElementById('themeSelect').value = document.body.getAttribute('data-theme') || 'light';
    document.getElementById('themeSelect').onchange = (e) => document.body.setAttribute('data-theme', e.target.value);

    document.getElementById('changePassBtn').onclick = () => {
      if(!currentUser){ alert('Musisz byƒá zalogowany.'); return; }
      const oldP = document.getElementById('oldPass').value;
      const newP = document.getElementById('newPass').value;
      const users = loadUsers();
      const me = users.find(x => x.id === currentUser.id);
      if(me.pass !== oldP){ alert('Stare has≈Ço nie pasuje.'); return; }
      if(!newP){ alert('Podaj nowe has≈Ço.'); return; }
      me.pass = newP;
      saveUsers(users);
      broadcast('user-update', { id: me.id });
      alert('Has≈Ço zmienione.');
      closeModal();
    };
  }

  function openChangeEmailModal(){
    if(!currentUser) return openLoginModal();
    openModal(`
      <h3>Zmie≈Ñ email</h3>
      <div style="display:flex;flex-direction:column;gap:8px">
        <input id="newEmail" type="email" value="${currentUser.email}" />
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="cancelEmail" class="pill small">Anuluj</button>
          <button id="saveEmail" class="pill small">Zapisz</button>
        </div>
      </div>
    `);
    document.getElementById('cancelEmail').onclick = closeModal;
    document.getElementById('saveEmail').onclick = () => {
      const ne = document.getElementById('newEmail').value.trim().toLowerCase();
      if(!ne) return alert('Podaj email.');
      const users = loadUsers();
      if(users.some(x => x.email.toLowerCase() === ne && x.id !== currentUser.id)) return alert('Email zajƒôty.');
      const me = users.find(x => x.id === currentUser.id);
      me.email = ne;
      saveUsers(users);
      broadcast('user-update', { id: me.id });
      currentUser = me;
      renderProfile();
      closeModal();
    };
  }

  /* --------- Admin panel (Genera≈Çowie + owner) --------- */
  function openAdminPanel(){
    if(!currentUser) return openLoginModal();
    if(!(currentUser.rank === 'Genera≈Ç' || currentUser.isOwner)) return alert('Brak uprawnie≈Ñ.');

    const users = loadUsers().filter(x => !x.isOwner);
    openModal(`
      <h3>Panel admina</h3>
      <div style="display:flex;flex-direction:column;gap:8px;max-height:60vh;overflow:auto">
        ${users.map(u => `
          <div style="display:flex;justify-content:space-between;align-items:center;padding:8px;border-bottom:1px solid rgba(0,0,0,0.04)">
            <div>
              <strong>${u.name} ${u.lastName}</strong>
              <div class="small">${u.email}</div>
            </div>
            <div style="display:flex;gap:6px">
              <button class="pill small admin-kick" data-id="${u.id}">Wyrzuƒá</button>
              <button class="pill small admin-mute" data-id="${u.id}">${u.muted ? 'Odmute' : 'Wycisz'}</button>
              <button class="pill small admin-warn" data-id="${u.id}">Ostrze≈º</button>
              <button class="pill small admin-block" data-id="${u.id}">${u.blocked ? 'Odblokuj' : 'Zablokuj'}</button>
            </div>
          </div>`).join('')}
      </div>
      <div style="display:flex;justify-content:flex-end;margin-top:8px"><button id="closeAdmin" class="pill small">Zamknij</button></div>
    `);

    document.getElementById('closeAdmin').onclick = closeModal;

    document.querySelectorAll('.admin-kick').forEach(b => b.onclick = () => {
      const id = b.dataset.id;
      if(!confirm('Wyrzuciƒá u≈ºytkownika?')) return;
      const us = loadUsers().filter(x => x.id !== id);
      saveUsers(us);
      broadcast('user-update', { id });
      renderUserList();
      closeModal();
      alert('U≈ºytkownik usuniƒôty.');
    });

    document.querySelectorAll('.admin-mute').forEach(b => b.onclick = () => {
      const id = b.dataset.id;
      const users = loadUsers();
      const t = users.find(x => x.id === id);
      t.muted = !t.muted;
      saveUsers(users);
      broadcast('admin-action', { type: 'mute', target: id, by: currentUser.id, muted: t.muted });
      renderUserList();
      alert(t.muted ? 'U≈ºytkownik wyciszony.' : 'U≈ºytkownik odciszony.');
    });

    document.querySelectorAll('.admin-warn').forEach(b => b.onclick = () => {
      const id = b.dataset.id;
      const users = loadUsers();
      const t = users.find(x => x.id === id);
      t.warned = true;
      saveUsers(users);
      broadcast('admin-action', { type: 'warn', target: id, by: currentUser.id });
      alert('U≈ºytkownik zosta≈Ç ostrze≈ºony.');
    });

    document.querySelectorAll('.admin-block').forEach(b => b.onclick = () => {
      const id = b.dataset.id;
      const users = loadUsers();
      const t = users.find(x => x.id === id);
      t.blocked = !t.blocked;
      saveUsers(users);
      broadcast('admin-action', { type: 'block', target: id, by: currentUser.id, blocked: t.blocked });
      renderUserList();
      alert(t.blocked ? 'U≈ºytkownik zablokowany.' : 'U≈ºytkownik odblokowany.');
    });
  }

  function applyAdminAction(payload){
    const users = loadUsers();
    const t = users.find(x => x.id === payload.target);
    if(!t) return;
    if(payload.type === 'mute'){
      t.muted = payload.muted !== undefined ? payload.muted : !t.muted;
      saveUsers(users);
      renderUserList();
    } else if(payload.type === 'warn'){
      t.warned = true; saveUsers(users); renderUserList();
    } else if(payload.type === 'block'){
      t.blocked = payload.blocked; saveUsers(users); renderUserList();
      if(currentUser && currentUser.id === t.id){
        if(t.blocked) { document.getElementById('overlayBlock').style.display = 'flex'; }
        else { document.getElementById('overlayBlock').style.display = 'none'; }
      }
    }
  }

  /* --------- Load on start: show login if not logged --------- */
  function createOwnerIfMissing(){
    const users = loadUsers();
    if(!users.find(x => x.email === OWNER_EMAIL)){
      users.push({
        id: uid(),
        name: OWNER_NAME,
        lastName: OWNER_LAST,
        email: OWNER_EMAIL,
        pass: OWNER_PASS,
        rank: 'Genera≈Ç',
        isOwner: true,
        lastSeen: now(),
        muted: false,
        blocked: false,
        warned: false
      });
      saveUsers(users);
    }
  }
  createOwnerIfMissing();

  window.addEventListener('load', () => {
    const sess = JSON.parse(localStorage.getItem(STORAGE_SESSION) || 'null');
    if(sess){
      const users = loadUsers();
      const u = users.find(x => x.id === sess.id);
      if(u){ currentUser = u; renderAuthArea(); renderProfile(); if(u.blocked) document.getElementById('overlayBlock').style.display = 'flex'; }
    }
    if(!currentUser) showLoginOnStart();
    renderMessages();
    renderUserList();
  });

  /* react to storage changes */
  window.addEventListener('storage', (e) => {
    if(e.key === STORAGE_CHAT || e.key === STORAGE_USERS){
      renderMessages();
      renderUserList();
    }
  });

  /* expose some functions to global (for debugging if needed) */
  window._qd = {
    loadUsers, loadChat, saveUsers, saveChat, uid
  };
  </script>
</body>
</html>
